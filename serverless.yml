service:
  name: dog-finder-api

provider:
  name: aws
  runtime: nodejs12.x
  frameworkVersion: '1.75.1'
  stage: ${opt:stage, 'local'}
  region: ${opt:region, 'us-east-1'}
  apiGateway:
    minimumCompressionSize: 1024 # Enable gzip compression for responses > 1 KB
  tracing:
    lambda: true
  environment:
    DEBUG: '*'
    NODE_ENV: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    DB_NAME: dog-finder-db
    CONFIG_DYNAMODB_ENDPOINT: ${self:custom.endpoints.dynamodb-local}
    JWT_SECRET: secret
    
  iamRoleStatements:
    - Effect: Allow
      Action:
        - xray:PutTraceSegments
        - xray:PutTelemetryRecords
      Resource: "*"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:us-east-1:983570756921:table/dog-finder-db"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
      Resource: "arn:aws:dynamodb:us-east-1:983570756921:table/dog-finder-db/index/*"
    - Effect: Allow
      Action:
        - s3:PutObject
      Resource: "arn:aws:s3:::dog-finder-images/*"

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: true
    packager: "yarn"
  serverless-iam-roles-per-function:
    defaultInherit: true # Each function will inherit the service level roles too.
  prune: # automatically prune old lambda versions
    automatic: true
    number: 3
  endpoints:
    dynamodb-local: 'http://localhost:8000'

# Add the serverless-webpack plugin
plugins:
  - serverless-offline
  - serverless-webpack
  - serverless-iam-roles-per-function
  - serverless-prune-plugin

functions:
  foundDogCreate:
    handler: src/handlers/foundDog.create
    events:
      - http:
          method: post
          path: found-dog
  foundDogDelete:
    handler: src/handlers/foundDog.del
    events:
      - http:
          method: delete
          path: found-dog/{id}
  foundDogEdit:
    handler: src/handlers/foundDog.edit
    events:
      - http:
          method: put
          path: found-dog/{id}
  foundDogDetail:
    handler: src/handlers/foundDog.detail
    events:
      - http:
          method: get
          path: found-dog/{id}
  foundDogList:
    handler: src/handlers/foundDog.list
    events:
      - http:
          method: get
          path: found-dog
  lostDogCreate:
    handler: src/handlers/lostDog.create
    events:
      - http:
          method: post
          path: lost-dog
  lostDogDelete:
    handler: src/handlers/lostDog.del
    events:
      - http:
          method: delete
          path: lost-dog/{id}
  lostDogEdit:
    handler: src/handlers/lostDog.edit
    events:
      - http:
          method: put
          path: lost-dog/{id}
  lostDogDetail:
    handler: src/handlers/lostDog.detail
    events:
      - http:
          method: get
          path: lost-dog/{id}
  lostDogList:
    handler: src/handlers/lostDog.list
    events:
      - http:
          method: get
          path: lost-dog
  imageUpload:
    handler: src/handlers/images.upload
    events:
      - http:
          path: upload
          method: get

  userCreate:
    handler: src/handlers/users.create
    events:
      - http:
          path: sign-up
          method: post
  
  userDetail:
    handler: src/handlers/users.detail
    events:
      - http:
          path: user/{email}
          method: get

  userLogin:
    handler: src/handlers/users.login
    events:
      - http:
          path: log-in
          method: post

